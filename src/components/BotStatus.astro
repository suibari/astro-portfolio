---
import StatusPanel from "./StatusPanel.astro";
import ChartPanel from "./ChartPanel.astro";
import TopPostPanel from "./TopPostPanel.astro";
import RetroStatus from "./RetroStatus.astro";
---

<div class="bg-white rounded-lg">
  <h2 class="text-2xl font-bold mb-4 flex items-center">
    ğŸ’– BotãŸã‚“ã®ãã‚‚ã¡ (ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°)
  </h2>
  <p class="text-gray-600 mb-4 flex gap-2 items-center">
    <span id="websocket-status" class="w-3 h-3 rounded-full"></span>
    <strong>ç¾åœ¨æ™‚åˆ»(JST):</strong>
    <span id="jst-time" class="mr-2">--:--:--</span>
  </p>

  <h2 class="vt323-regular text-4xl mt-4">ABILITY SCORE</h2>
  <RetroStatus />

  <h2 class="vt323-regular text-4xl mt-4">DAILY STATS</h2>
  <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4">
    <StatusPanel title="å¢—ãˆãŸãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼" value="---" id="followers" />
    <StatusPanel title="ã„ã„ã­ã•ã‚ŒãŸå›æ•°" value="---" id="likes" />
    <StatusPanel title="ã„ã„ã­ã•ã‚Œé€Ÿåº¦ (æ¯åˆ†)" value="---" id="likes-speed" />
    <StatusPanel title="å…¨è‚¯å®šã—ãŸå›æ•°" value="---" id="affirmationCount" />
    <StatusPanel title="å…¨è‚¯å®šé€Ÿåº¦ (æ¯åˆ†)" value="---" id="affirmation-speed" />
    <StatusPanel
      title="å…¨è‚¯å®šã—ãŸäººæ•°"
      value="---"
      id="uniqueAffirmationUserCount"
    />
    <StatusPanel title="å ã£ãŸå›æ•°" value="---" id="fortune" />
    <StatusPanel title="å¿œæ´ã—ãŸå›æ•°" value="---" id="cheer" />
    <StatusPanel title="åˆ†æã—ãŸå›æ•°" value="---" id="analysis" />
    <StatusPanel title="DJã—ãŸå›æ•°" value="---" id="dj" />
    <StatusPanel title="è¨˜å¿µæ—¥ãŠç¥ã„å›æ•°" value="---" id="anniversary" />
    <StatusPanel title="è³ªå•ã‚³ãƒ¼ãƒŠãƒ¼å›ç­”æ•°" value="---" id="answer" />
    <StatusPanel
      title="Rate Limit Point (æ¯æ™‚)"
      value="---"
      id="bskyrate-hourly"
    />
    <StatusPanel title="AI Requestæ•°" value="---" id="rpd" />
  </div>

  <div class="flex flex-col md:flex-row gap-4 mb-4">
    <ChartPanel title="ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ¨ç§»" canvasId="follower-chart" />
    <ChartPanel title="ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ã®ä½¿ç”¨è¨€èª" canvasId="lang-chart" />
  </div>

  <h2 class="vt323-regular text-4xl mt-4">BOT-TAN's RECOMMENDATION POST</h2>
  <TopPostPanel title="" />
  <StatusPanel title="botãŸã‚“ã®ã‚³ãƒ¡ãƒ³ãƒˆ:" value="---" id="daily-comment" />
</div>

<script>
  import { AtpAgent } from "@atproto/api";
  import Chart from "chart.js/auto"; // Chart.jsã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
  import "chartjs-adapter-date-fns"; // date-fnsã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
  import { fetchFollowerData } from "../services/bottan/fetchFollowerData"; // ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—é–¢æ•°ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

  // èªè¨¼ä¸è¦ã®å…¬é–‹APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æŒ‡å®š
  const agent = new AtpAgent({ service: "https://public.api.bsky.app" });

  let langChart: Chart | null = null; // Chartã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
  let followerChart: Chart | null = null; // ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ¨ç§»ã‚°ãƒ©ãƒ•ã®Chartã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿æŒã™ã‚‹å¤‰æ•°

  const mode = import.meta.env.MODE;
  const socket = new WebSocket(
    `${mode === "production" ? "wss://bot-tan.suibari.com" : "ws://localhost:3000"}/ws`,
  );

  // ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ¨ç§»ã‚°ãƒ©ãƒ•ã®åˆæœŸåŒ–ã¨æ›´æ–°
  async function initFollowerChart() {
    const followerData = await fetchFollowerData();
    const followerChartEl = document.getElementById(
      "follower-chart",
    ) as HTMLCanvasElement;

    if (followerData && followerChartEl) {
      // date-fnsã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€æ—¥ä»˜æ–‡å­—åˆ—ã‚’ç›´æ¥æ¸¡ã™
      const labels = followerData.map(
        (item: { date: string; count: number }) => item.date,
      );
      const counts = followerData.map(
        (item: { date: string; count: number }) => item.count,
      );

      if (followerChart) {
        followerChart.data.labels = labels;
        followerChart.data.datasets[0].data = counts;
        followerChart.update();
      } else {
        followerChart = new Chart(followerChartEl, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°",
                data: counts,
                borderColor: "rgb(75, 192, 192)",
                tension: 0.1,
                fill: false,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: "top",
              },
              title: {
                display: false,
                text: "ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ¨ç§»",
              },
            },
            scales: {
              x: {
                type: "time", // æ™‚é–“è»¸ã«å¤‰æ›´
                time: {
                  unit: "day", // æ™‚é–“å˜ä½ã‚’æ—¥ã«ã™ã‚‹
                  tooltipFormat: "yyyy/MM/dd HH:mm", // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã®è¡¨ç¤ºå½¢å¼
                  displayFormats: {
                    day: "MM/dd", // è»¸ã®è¡¨ç¤ºå½¢å¼ã‚’æ—¥ä»˜ã®ã¿ã«
                  },
                },
                title: {
                  display: true,
                  text: "æ—¥ä»˜", // è»¸ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’ã€Œæ—¥ä»˜ã€ã«å¤‰æ›´
                },
              },
              y: {
                title: {
                  display: true,
                  text: "ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°",
                },
              },
            },
          },
        });
      }
    }
  }

  // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ¨ç§»ã‚°ãƒ©ãƒ•ã‚’åˆæœŸåŒ–
  initFollowerChart();

  socket.onmessage = async (event) => {
    const data = JSON.parse(event.data);
    console.log("Received data:", data); // ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ãƒ­ã‚°å‡ºåŠ›

    // ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ã•ã›ã¦ä»–ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™
    const customEvent = new CustomEvent("botStatusUpdated", { detail: data });
    document.dispatchEvent(customEvent);

    const moodEl = document.getElementById("mood");
    if (moodEl) moodEl.textContent = data.mood || "No Status";

    const moodImageEl = document.getElementById(
      "mood-image",
    ) as HTMLImageElement;
    if (moodImageEl && data.status) {
      const imageMap: { [key: string]: string } = {
        Sleep: "/images/bot-tan/bsky_bot_icon_sleep.png",
        WakeUp: "/images/bot-tan/bsky_bot_icon_wakeup.png",
        Study: "/images/bot-tan/bsky_bot_icon_study.png",
        FreeTime: "/images/bot-tan/bsky_bot_icon_freetime.png",
        Relax: "/images/bot-tan/bsky_bot_icon_relax.png",
      };

      const imagePath =
        imageMap[data.status] || "/images/bot-tan/bsky_bot_icon_relax.png"; // Default to Relax if status not found
      moodImageEl.src = imagePath;
      // Remove opacity-0 to show the image with fade-in transition
      moodImageEl.classList.remove("opacity-0");
    }

    const nextStepTimeEl = document.getElementById("next-step-time");
    if (nextStepTimeEl) {
      if (data.nextStepTime) {
        const date = new Date(data.nextStepTime);
        const timeString = date.toLocaleTimeString("ja-JP", {
          timeZone: "Asia/Tokyo",
          hour12: false,
        });
        nextStepTimeEl.textContent = timeString;
      } else {
        nextStepTimeEl.textContent = "---";
      }
    }

    if (data.utilities) {
      const utilityMap = {
        Sleep: "utility-sleep",
        WakeUp: "utility-wakeup",
        Study: "utility-study",
        FreeTime: "utility-freetime",
        Relax: "utility-relax",
      };

      // Reset all panels
      Object.values(utilityMap).forEach((id) => {
        const panel = document.getElementById(`panel-${id}`);
        if (panel) {
          panel.classList.remove("bg-yellow-100", "ring-2", "ring-yellow-400");
          panel.classList.add("bg-gray-100");
        }
      });

      // Highlight active panel
      if (data.status && utilityMap[data.status as keyof typeof utilityMap]) {
        const activeId = utilityMap[data.status as keyof typeof utilityMap];
        const activePanel = document.getElementById(`panel-${activeId}`);
        if (activePanel) {
          activePanel.classList.remove("bg-gray-100");
          activePanel.classList.add(
            "bg-yellow-100",
            "ring-2",
            "ring-yellow-400",
          );
        }
      }

      const sleepEl = document.getElementById("utility-sleep");
      if (sleepEl)
        sleepEl.textContent =
          data.utilities.Sleep !== undefined
            ? Math.round(data.utilities.Sleep).toString()
            : "---";

      const wakeUpEl = document.getElementById("utility-wakeup");
      if (wakeUpEl)
        wakeUpEl.textContent =
          data.utilities.WakeUp !== undefined
            ? Math.round(data.utilities.WakeUp).toString()
            : "---";

      const studyEl = document.getElementById("utility-study");
      if (studyEl)
        studyEl.textContent =
          data.utilities.Study !== undefined
            ? Math.round(data.utilities.Study).toString()
            : "---";

      const freeTimeEl = document.getElementById("utility-freetime");
      if (freeTimeEl)
        freeTimeEl.textContent =
          data.utilities.FreeTime !== undefined
            ? Math.round(data.utilities.FreeTime).toString()
            : "---";

      const relaxEl = document.getElementById("utility-relax");
      if (relaxEl)
        relaxEl.textContent =
          data.utilities.Relax !== undefined
            ? Math.round(data.utilities.Relax).toString()
            : "---";
    }

    const followersEl = document.getElementById("followers");
    if (followersEl) followersEl.textContent = data.dailyStats.followers;

    const likesEl = document.getElementById("likes");
    if (likesEl) likesEl.textContent = data.dailyStats.likes;

    const affirmationCountEl = document.getElementById("affirmationCount");
    if (affirmationCountEl)
      affirmationCountEl.textContent = data.dailyStats.affirmationCount;

    const uniqueAffirmationUserCountEl = document.getElementById(
      "uniqueAffirmationUserCount",
    );
    if (uniqueAffirmationUserCountEl)
      uniqueAffirmationUserCountEl.textContent =
        data.dailyStats.uniqueAffirmationUserCount;

    const fortuneEl = document.getElementById("fortune");
    if (fortuneEl) fortuneEl.textContent = data.dailyStats.fortune;

    const cheerEl = document.getElementById("cheer");
    if (cheerEl) cheerEl.textContent = data.dailyStats.cheer;

    const analysisEl = document.getElementById("analysis");
    if (analysisEl) analysisEl.textContent = data.dailyStats.analysis;

    const djEl = document.getElementById("dj");
    if (djEl) djEl.textContent = data.dailyStats.dj;

    const anniversaryEl = document.getElementById("anniversary");
    if (anniversaryEl) anniversaryEl.textContent = data.dailyStats.anniversary;

    const answerEl = document.getElementById("answer");
    if (answerEl) answerEl.textContent = data.dailyStats.answer;

    const rpdEl = document.getElementById("rpd");
    if (rpdEl) rpdEl.textContent = data.dailyStats.rpd;

    const dailyCommentEl = document.getElementById("daily-comment");
    if (dailyCommentEl) dailyCommentEl.textContent = data.dailyStats.botComment;

    // --- New logic for lang chart ---
    const langData = data.dailyStats.lang;
    const langChartEl = document.getElementById(
      "lang-chart",
    ) as HTMLCanvasElement;

    if (langData && langChartEl) {
      const labels = langData.map((item: [string, number]) => item[0]);
      const values = langData.map((item: [string, number]) => item[1]);

      if (langChart) {
        langChart.data.labels = labels;
        langChart.data.datasets[0].data = values;
        langChart.update();
      } else {
        langChart = new Chart(langChartEl, {
          type: "pie",
          data: {
            labels: labels,
            datasets: [
              {
                data: values,
                hoverOffset: 4,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: "top",
              },
              title: {
                display: false,
                text: "ä½¿ç”¨è¨€èª",
              },
            },
          },
        });
      }
    }
    // --- End of new logic for lang chart ---

    // --- New logic for speeds ---
    const likesSpeedEl = document.getElementById("likes-speed");
    const affirmationSpeedEl = document.getElementById("affirmation-speed");

    // Check if lastInitializedDate is available in the data
    if (
      data.dailyStats &&
      data.dailyStats.lastInitializedDate &&
      likesEl &&
      affirmationCountEl &&
      likesSpeedEl &&
      affirmationSpeedEl
    ) {
      const now = new Date();
      const lastInitializedDate = new Date(data.dailyStats.lastInitializedDate);
      const timeDifferenceInSeconds =
        (now.getTime() - lastInitializedDate.getTime()) / 1000;

      if (timeDifferenceInSeconds > 0) {
        const likesPerMinute =
          (data.dailyStats.likes / timeDifferenceInSeconds) * 60;
        const affirmationCountPerMinute =
          (data.dailyStats.affirmationCount / timeDifferenceInSeconds) * 60;

        if (likesSpeedEl) likesSpeedEl.textContent = likesPerMinute.toFixed(1);
        if (affirmationSpeedEl)
          affirmationSpeedEl.textContent = affirmationCountPerMinute.toFixed(1);
      } else {
        // Handle cases where time difference is zero or negative (should not happen with valid data)
        if (likesSpeedEl) likesSpeedEl.textContent = "N/A";
        if (affirmationSpeedEl) affirmationSpeedEl.textContent = "N/A";
      }
    } else {
      // If lastInitializedDate is not available or elements are missing, display placeholder
      if (likesSpeedEl) likesSpeedEl.textContent = "---";
      if (affirmationSpeedEl) affirmationSpeedEl.textContent = "---";
    }
    // --- End of new logic ---

    // --- New logic for bskyrate ---
    const bskyrateHourlyEl = document.getElementById("bskyrate-hourly");
    if (
      data.dailyStats &&
      data.dailyStats.bskyrate &&
      data.dailyStats.lastInitializedDate &&
      bskyrateHourlyEl
    ) {
      const now = new Date();
      const lastInitializedDate = new Date(data.dailyStats.lastInitializedDate);
      const timeDifferenceInSeconds =
        (now.getTime() - lastInitializedDate.getTime()) / 1000;

      if (timeDifferenceInSeconds > 0) {
        const bskyratePerHour =
          (data.dailyStats.bskyrate / timeDifferenceInSeconds) * 3600;
        if (bskyrateHourlyEl)
          bskyrateHourlyEl.textContent = bskyratePerHour.toFixed(1);
      } else {
        if (bskyrateHourlyEl) bskyrateHourlyEl.textContent = "N/A";
      }
    } else {
      if (bskyrateHourlyEl) bskyrateHourlyEl.textContent = "---";
    }
    // --- End of new logic ---
  };

  function updateJSTTime() {
    const now = new Date();
    const jst = new Date(now.getTime() + 9 * 60 * 60 * 1000);
    const timeString = jst.toISOString().substr(11, 8);
    const jstTimeEl = document.getElementById("jst-time");
    if (jstTimeEl) jstTimeEl.textContent = timeString;
  }

  updateJSTTime();
  setInterval(updateJSTTime, 1000);

  const websocketStatusEl = document.getElementById("websocket-status");

  socket.onopen = () => {
    if (websocketStatusEl) {
      websocketStatusEl.className = "w-3 h-3 rounded-full bg-green-500";
      websocketStatusEl.title = "WebSocketæ¥ç¶šä¸­";
    }
  };

  socket.onclose = () => {
    if (websocketStatusEl) {
      websocketStatusEl.className = "w-3 h-3 rounded-full bg-red-500";
      websocketStatusEl.title = "WebSocketåˆ‡æ–­";
    }
  };

  socket.onerror = (error) => {
    console.error("WebSocket Error:", error);
    if (websocketStatusEl) {
      websocketStatusEl.className = "w-3 h-3 rounded-full bg-red-500";
      websocketStatusEl.title = "WebSocketã‚¨ãƒ©ãƒ¼";
    }
  };

  // åˆæœŸçŠ¶æ…‹ã®è¡¨ç¤º
  if (websocketStatusEl) {
    if (socket.readyState === WebSocket.OPEN) {
      websocketStatusEl.className = "w-3 h-3 rounded-full bg-green-500";
      websocketStatusEl.title = "WebSocketæ¥ç¶šä¸­";
    } else if (socket.readyState === WebSocket.CONNECTING) {
      websocketStatusEl.className = "w-3 h-3 rounded-full bg-yellow-500";
      websocketStatusEl.title = "WebSocketæ¥ç¶šè©¦è¡Œä¸­";
    } else {
      websocketStatusEl.className = "w-3 h-3 rounded-full bg-red-500";
      websocketStatusEl.title = "WebSocketåˆ‡æ–­";
    }
  }
</script>
